name: 'Install macOS Dependencies'
description: 'Install dependencies for building and testing MetaGraph on macOS'

inputs:
  install_test_deps:
    description: 'Whether to install integration test dependencies'
    required: false
    default: 'false'
  target_arch:
    description: 'Target architecture (arm64 or x86_64)'
    required: false
    default: 'arm64'

runs:
  using: "composite"
  steps:
    - name: (Only for arm64 -> x86_64) Install Rosetta Homebrew in /usr/local
      if: ${{ inputs.target_arch == 'x86_64' }}
      shell: ${{ runner.os == 'macOS' && format('arch -{0} /bin/bash -e {{0}}', inputs.target_arch) || 'bash' }}
      run: |
        # Install Intel Homebrew into /usr/local if missing
        if [[ ! -d /usr/local/Homebrew ]]; then
          echo "Installing Intel Homebrew to /usr/local under Rosetta..."
          arch -x86_64 /bin/bash -lc '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
        fi
        # Replace any legacy wrapper that points to /usr/local/Library/Homebrew
        if [[ -f /usr/local/bin/brew ]] && grep -q '/usr/local/Library/Homebrew' /usr/local/bin/brew; then
          echo "Replacing legacy brew wrapper..."
          sudo rm -f /usr/local/bin/brew
        fi
        # Ensure wrapper points to the modern repo location
        if [[ ! -f /usr/local/bin/brew ]]; then
          sudo ln -s /usr/local/Homebrew/bin/brew /usr/local/bin/brew
        fi
        echo "/usr/local/bin" >> "$GITHUB_PATH"
        echo "/usr/local/sbin" >> "$GITHUB_PATH"

    - name: install dependencies
      run: brew install bzip2 libomp boost jemalloc autoconf automake libdeflate ccache
      shell: ${{ runner.os == 'macOS' && format('arch -{0} /bin/bash -e {{0}}', inputs.target_arch) || 'bash' }}

    - name: install dependencies for integration tests
      if: inputs.install_test_deps == 'true'
      shell: bash
      run: pip3 install parameterized --break-system-packages --user
